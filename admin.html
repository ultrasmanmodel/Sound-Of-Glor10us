<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Data Pemesan Tiket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    h2 { text-align: center; margin: 20px 0; color: #222; }
    .login-container { max-width: 360px; margin: 100px auto; padding: 20px; background: #fff;
      border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);}
    .login-container input, .login-container button { width: 100%; padding: 12px; margin: 8px 0;
      border-radius: 6px; font-size: 16px; }
    .login-container button { background: #7a7a7b; color: white; border: none; cursor: pointer; }
    .login-container button:hover { background: #5e5e5f; }
    .data-container { padding: 20px 40px; }
    .nav-tabs { display: flex; justify-content: center; margin-bottom: 20px; gap: 20px; }
    .nav-tabs button { padding: 10px 20px; border: none; background: #ccc; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .nav-tabs button.active { background: #7a7a7b; color: #fff; }
    .table-container { overflow-x: auto; background: #fff; padding: 10px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05); margin-bottom: 15px;}
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; font-size: 14px; }
    th { background: #7a7a7b; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #e6e6e6; }
    .logout-btn { padding: 10px 24px; background: #7a7a7b; color: white; border: none;
      border-radius: 6px; cursor: pointer; float: right; }
    .logout-btn:hover { background: #5e5e5f; }
    img.bukti-thumb { max-height: 80px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .export-btn { padding: 10px 20px; background: green; color: #fff; border: none;
      border-radius: 6px; cursor: pointer; margin-bottom: 10px;}
    .export-btn:hover { background: darkgreen; }
  </style>
</head>
<body>

<!-- LOGIN ADMIN -->
<div class="login-container" id="loginForm">
  <h2>Login Admin</h2>
  <input type="text" id="username" placeholder="Masukkan Username" autocomplete="off" />
  <input type="password" id="password" placeholder="Masukkan Password" />
  <button onclick="login()">Masuk</button>
</div>

<!-- PANEL ADMIN -->
<div class="data-container" id="adminPanel" style="display:none;">
  <h2>Data Pemesan Tiket 1 Dekade Ultras Manmodel</h2>

  <!-- TAB NAV -->
  <div class="nav-tabs">
    <button id="tabPemesan" class="active" onclick="showTab('pemesan')">Data Pemesan</button>
    <button id="tabMasuk" onclick="showTab('masuk')">Data Masuk Tiket</button>
  </div>

  <!-- TAB: DATA PEMESAN -->
  <div id="tabPemesanContent">
    <input type="text" id="searchInvoice" placeholder="Cari Nomor Invoice..." style="width: 100%; padding: 8px; margin-bottom: 12px;" oninput="filterPemesan()" />
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>No</th><th>Nomor Invoice</th><th>Nama Lengkap</th><th>Email</th>
            <th>No KTP</th><th>No Telepon</th><th>Kategori Tiket</th><th>Harga Tiket</th>
            <th>Metode Pembayaran</th><th>Waktu Pemesanan</th><th>Bukti Pembayaran</th><th>Centang</th>
          </tr>
        </thead>
        <tbody id="tabelPemesan"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB: DATA MASUK TIKET -->
  <div id="tabMasukContent" style="display:none;">
    <button class="export-btn" onclick="exportTableToExcel('tiket_masuk.xls')">Export Excel</button>
    <div class="table-container">
      <table id="tabelMasukWrapper">
        <thead>
          <tr>
            <th>No</th><th>Nomor Invoice</th><th>Nama Lengkap</th><th>Email</th>
            <th>No KTP</th><th>No Telepon</th><th>Kategori Tiket</th><th>Harga Tiket</th>
            <th>Metode Pembayaran</th><th>Waktu Pemesanan</th><th>Bukti Pembayaran</th>
          </tr>
        </thead>
        <tbody id="tabelMasuk"></tbody>
      </table>
    </div>
  </div>

  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script>
  const hargaTiket = { "Early Bird": "Rp 50.000" };
  const kuotaMax = 10;

  const firebaseConfig = {
    apiKey: "AIzaSyD1HWtoCb-EOapsJu7wnOXIXTEtQEOLCZ8",
    authDomain: "satudekade-4b54a.firebaseapp.com",
    databaseURL: "https://satudekade-4b54a-default-rtdb.firebaseio.com",
    projectId: "satudekade-4b54a",
    storageBucket: "satudekade-4b54a.appspot.com",
    messagingSenderId: "76649124389",
    appId: "1:76649124389:web:3b0b7072ea71e7ece7a5cc"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let pemesanData = {};
  const tabel = document.getElementById('tabelPemesan');
  const tabelMasuk = document.getElementById('tabelMasuk');

  // ✅ Login
  function login() {
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;
    if (user === 'admin' && pass === 'ultrasmanmodel') {
      localStorage.setItem('adminLoggedIn', 'true');
      showAdminPanel();
    } else alert('Username atau password salah!');
  }
  function logout() { localStorage.removeItem('adminLoggedIn'); location.reload(); }
  window.onload = () => { if (localStorage.getItem('adminLoggedIn') === 'true') showAdminPanel(); };

  function showAdminPanel() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    loadData(); loadDataMasuk();
  }
  function showTab(tab) {
    document.getElementById('tabPemesanContent').style.display = (tab==='pemesan')?'block':'none';
    document.getElementById('tabMasukContent').style.display = (tab==='masuk')?'block':'none';
    document.getElementById('tabPemesan').classList.toggle('active',tab==='pemesan');
    document.getElementById('tabMasuk').classList.toggle('active',tab==='masuk');
  }

  function parseTanggal(str) { try { return new Date(str).toLocaleString('id-ID'); } catch { return str; } }

  // ✅ Hitung kuota
  async function cekKuota() {
    const snap = await db.ref('dataMasukTiket').once('value');
    return snap.size;
  }

  // ✅ Load pemesanan
  function loadData() {
    db.ref('pemesanan').on('value', snap => {
      pemesanData = {}; tabel.innerHTML = '';
      snap.forEach(child => { pemesanData[child.key] = child.val(); });
      renderPemesanTable(pemesanData);
    });
  }
  function renderPemesanTable(dataObj) {
    tabel.innerHTML=''; let no=1;
    for (const key in dataObj) {
      const d=dataObj[key]; const harga=hargaTiket[d.kategori]||'-';
      tabel.innerHTML += `
        <tr>
          <td>${no++}</td><td>${d.invoice}</td><td>${d.nama}</td><td>${d.email}</td>
          <td>${d.ktp}</td><td>${d.telepon}</td><td>${d.kategori}</td><td>${harga}</td>
          <td>${d.metode}</td><td>${parseTanggal(d.timestamp)}</td>
          <td><img src="${d.bukti}" class="bukti-thumb" onclick="window.open('${d.bukti}','_blank')"></td>
          <td><input type="checkbox" onchange="kirimKeDataMasuk('${key}',this)"></td>
        </tr>`;
    }
  }
  function filterPemesan() {
    const f=document.getElementById('searchInvoice').value.toLowerCase(); const filtered={};
    for(const k in pemesanData){ if(pemesanData[k].invoice.toLowerCase().includes(f)) filtered[k]=pemesanData[k]; }
    renderPemesanTable(filtered);
  }

  // ✅ Load Data Masuk dengan nomor urut permanen
  function loadDataMasuk() {
    db.ref('dataMasukTiket').orderByChild('noUrut').on('value', snap => {
      tabelMasuk.innerHTML=''; 
      snap.forEach(child => {
        const d=child.val(); const harga=hargaTiket[d.kategori]||'-';
        tabelMasuk.innerHTML += `
          <tr>
            <td>${d.noUrut}</td><td>${d.invoice}</td><td>${d.nama}</td><td>${d.email}</td>
            <td>${d.ktp}</td><td>${d.telepon}</td><td>${d.kategori}</td><td>${harga}</td>
            <td>${d.metode}</td><td>${parseTanggal(d.timestamp)}</td>
            <td><img src="${d.bukti}" class="bukti-thumb" onclick="window.open('${d.bukti}','_blank')"></td>
          </tr>`;
      });
    });
  }

  // ✅ Pindah data dengan nomor urut berurutan
  async function kirimKeDataMasuk(id, checkbox) {
    checkbox.disabled=true;
    if(checkbox.checked){
      const terpakai=await cekKuota();
      if(terpakai>=kuotaMax){ alert('Kuota tiket sudah habis (10 tiket terjual)'); checkbox.checked=false; checkbox.disabled=false; return; }
      const snap=await db.ref('pemesanan/'+id).once('value');
      if(snap.exists()){
        const data=snap.val();
        // Nomor urut baru = jumlah data + 1
        const snapMasuk = await db.ref('dataMasukTiket').once('value');
        const nextNo = snapMasuk.numChildren() + 1;
        data.noUrut = nextNo;
        await db.ref('dataMasukTiket/'+id).set(data);
        await db.ref('pemesanan/'+id).remove();
      }
      checkbox.disabled=false;
    } else {
      const snap=await db.ref('dataMasukTiket/'+id).once('value');
      if(snap.exists()){ 
        const data=snap.val();
        delete data.noUrut;
        await db.ref('pemesanan/'+id).set(data);
        await db.ref('dataMasukTiket/'+id).remove();
      }
      checkbox.disabled=false;
    }
  }

  // ✅ Export Excel
  function exportTableToExcel(filename='export.xls'){
    const table=document.getElementById("tabelMasukWrapper").outerHTML;
    const data=`<html><head><meta charset="UTF-8"></head><body>${table}</body></html>`;
    const blob=new Blob([data],{type:'application/vnd.ms-excel'});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob); link.download=filename; link.click();
  }
</script>
</body>
</html>
